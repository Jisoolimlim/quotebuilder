<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quote Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui','Apple SD Gothic Neo','Noto Sans KR','Segoe UI','Roboto','Helvetica Neue','Arial','sans-serif'] },
          boxShadow: { soft: '0 10px 30px -12px rgba(0,0,0,0.2)'}
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @media print { .no-print{display:none!important;} body{background:white;} .page{box-shadow:none!important;} }
    .currency-badge { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="app"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // ---- Procedure catalog (base prices in KRW) ----
    const CATALOG = [
      { id: '수면마취', name: 'Anesthesia(Sedation)', baseKRW: 110000 },
      { id: '전신마취', name: 'General Anesthesia', baseKRW: 1100000 },
      { id: '눈밑지방이식', name: 'Nano fat grafting (under-eye)', baseKRW: 1650000 },
      { id: '눈밑지', name: 'Infraorbital fat repositioning', baseKRW: 2420000 },
      { id: '하안검', name: 'Lower Blepharoplasty', baseKRW: 2640000 },
      { id: '듀얼하안검', name: 'Dual Lower Blepharoplasty', baseKRW: 2750000 },
      { id: '하안검재수술', name: 'Revision Lower Blepharoplasty', baseKRW: 3300000 },
      { id: '상안검', name: 'Upper Blepharoplasty', baseKRW: 2640000 },
      { id: '상안검재수술', name: 'Revision Upper Blepharoplasty', baseKRW: 3300000 },
      { id: '눈썹하거상술', name: 'Subbrow Lift', baseKRW: 2420000 },
      
      { id: '비절개_쌍꺼풀', name: 'Non-incisional double eyelid', baseKRW: 1650000 },
      { id: '절개쌍커풀', name: 'Incisional double eyelid', baseKRW: 2420000 },
      { id: '비절개눈매교정', name: 'Non-incisional Canthoplasty', baseKRW: 1980000 },
      { id: '추가코', name: 'Extra nose augmentation', baseKRW: 770000 },
      { id: '기증늑', name: 'Donated rib cartilage', baseKRW: 1540000 },
      { id: '자가늑', name: 'Autologous rib cartilage', baseKRW: 3300000 },
      { id: '코첫수술', name: 'Rhinoplasty', baseKRW: 4400000 },
      { id: '코재수술', name: 'Revision Rhinoplasty', baseKRW: 5500000 },
      { id: '풀지방이식', name: 'Full facial fat grafting', baseKRW: 2200000 },
      { id: '미세지방이식', name: 'Micro fat grafting', baseKRW: 1320000 },
      { id: '이마거상', name: 'Forehead lift', baseKRW: 4950000 },
      { id: '이마축소', name: 'Forehead reduction', baseKRW: 3300000 },
      { id: '줄기세포30', name: 'Stem cell (30cc/skin)', baseKRW: 1320000 },
      { id: '줄기세포60', name: 'Stem cell (60cc/skin)', baseKRW: 2200000 },
      { id: '줄기세포120', name: 'Stem cell Premium (120cc)', baseKRW: 5500000 },
      { id: '줄기세포30', name: 'Stem cell (30cc/skin)', baseKRW: 13200000 },

      { id: '아큐얼굴지흡', name: 'Accusclupt-double chin', baseKRW: 1320000 },
      { id: '아큐얼굴지흡2', name: 'Accusclupt-double chin + contour', baseKRW: 1650000 },
      { id: '아큐민트8', name: 'Accusclupt + Mintvery', baseKRW: 2970000 },
      { id: '아랫배지흡', name: 'Lower abdomen liposuction', baseKRW: 4400000 },
      { id: '지흡윗배추가', name: 'Upper abdomen liposuction (add-on)', baseKRW: 1650000 },
      { id: '리쥬란힐러2', name: 'Rejuran Healer (2cc)', baseKRW: 484000 },
      { id: '리쥬란힐러4', name: 'Rejuran Healer (4cc)', baseKRW: 968000 },
      { id: '리쥬란아이1', name: 'Rejuran Eye (1cc)', baseKRW: 330000 },
      { id: '쥬베룩스킨4', name: 'Juvelook Skin (4cc)', baseKRW: 539000 },
      { id: '쥬베룩스킨8', name: 'Juvelook Skin (8cc/including neck)', baseKRW: 1078000 },
      { id: '쥬베룩볼륨4', name: 'Juvelook Volume (4cc)', baseKRW: 649000 },
      { id: '쥬베룩볼륨8', name: 'Juvelook Volume (8cc/including neck)', baseKRW: 1210000 },
      { id: '엘라비에리투오', name: 'Elravie Re2O (1syringe)', baseKRW: 770000 },
    ];

    // 1 KRW → target currency
    const DEFAULT_FX = { KRW: 1, USD: 0.00073, EUR: 0.00067, GBP: 0.00052, AUD: 0.00115, IDR: 11.3 };

    const CURRENCY_FORMAT = {
      KRW: { locale: 'ko-KR', currency: 'KRW', digits: 0 },
      USD: { locale: 'en-US', currency: 'USD', digits: 2 },
      EUR: { locale: 'de-DE', currency: 'EUR', digits: 2 },
      GBP: { locale: 'en-GB', currency: 'GBP', digits: 2 },
      AUD: { locale: 'en-AU', currency: 'AUD', digits: 2 },
      IDR: { locale: 'id-ID', currency: 'IDR', digits: 0 },
    };

    const STORAGE_KEY = 'surgery-quote-krw-v1';

    function useLocalState(key, initial) {
      const [v, setV] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initial; } catch { return initial; }
      });
      useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(v)); }catch{} }, [key, v]);
      return [v, setV];
    }

    function formatMoney(amount, curr) {
      const cfg = CURRENCY_FORMAT[curr] || CURRENCY_FORMAT.KRW;
      return new Intl.NumberFormat(cfg.locale, { style:'currency', currency:cfg.currency, minimumFractionDigits:cfg.digits, maximumFractionDigits:cfg.digits }).format(amount);
    }

    function App(){
      const [customName, setCustomName] = useState('');
      const [customPriceKRW, setCustomPriceKRW] = useState('');

      const addCustomFromFields = () => {
        if (!customName || !customPriceKRW) return;
        setItems([...items, {
          catalogId: null,
          name: customName,
          qty: 1,
          unitKRW: Number(customPriceKRW),
          note: ''
        }]);
        setCustomName('');
        setCustomPriceKRW('');
      };

      async function autoFetchRates(setFx, fx){
        try{
          const res = await fetch('https://api.exchangerate-api.com/v4/latest/KRW');
          const data = await res.json();
          if(data && data.rates){
            const next = { KRW: 1 };
            ['USD', 'EUR', 'GBP', 'AUD', 'IDR'].forEach(curr => {
              if (data.rates[curr]) {
                next[curr] = data.rates[curr];
              }
            });
            setFx(next);
            alert('환율이 자동으로 업데이트되었습니다. (기준: 1 KRW)');
          } else {
            alert('환율 API 응답을 불러오지 못했습니다. 잠시 후 다시 시도하세요.');
          }
        }catch(e){
          console.error('환율 업데이트 오류:', e);
          alert('환율 조회 실패: 네트워크 혹은 CORS 오류일 수 있습니다.');
        }
      }

      const [currency, setCurrency] = useLocalState(STORAGE_KEY+':currency', 'USD');
      const [fx, setFx] = useLocalState(STORAGE_KEY+':fx', DEFAULT_FX);
      const [items, setItems] = useLocalState(STORAGE_KEY+':items', []);
      const [taxPct, setTaxPct] = useLocalState(STORAGE_KEY+':tax', 0);
      const [discount, setDiscount] = useLocalState(STORAGE_KEY+':discount', { type:'amount', value:0 }); // amount in KRW or %

      const addCatalogItem = (c) => {
        if (items.find(i => i.catalogId === c.id)) return;
        setItems([...items, { catalogId:c.id, name:c.name, qty:1, unitKRW:c.baseKRW, note:'' }]);
      };
      const addCustomItem = () => setItems([...items, { catalogId:null, name:'기타 항목', qty:1, unitKRW:0, note:'' }]);
      const removeItem = (idx) => setItems(items.filter((_,i)=>i!==idx));
      const updateItem = (idx, patch) => setItems(items.map((it,i)=> i===idx?{...it,...patch}:it));

      const subtotalKRW = useMemo(()=> items.reduce((s,it)=> s + it.qty*it.unitKRW, 0), [items]);
      const taxKRW = useMemo(()=> subtotalKRW * (Number(taxPct)||0) / 100, [subtotalKRW, taxPct]);
      const discountKRW = useMemo(()=> {
        const v = Number(discount.value)||0; return discount.type==='percent' ? subtotalKRW * v/100 : v;
      }, [discount, subtotalKRW]);
      const totalKRW = Math.max(0, subtotalKRW + taxKRW - discountKRW);

      const rate = fx[currency] || 1;            // 1 KRW = rate * (currency)
      const toCurr = (krw) => {
        const cfg = CURRENCY_FORMAT[currency] || { digits:2 };
        const val = krw * rate; const p = Math.pow(10, cfg.digits ?? 2);
        return Math.round(val * p) / p;
      };

      const subtotal = toCurr(subtotalKRW);
      const tax = toCurr(taxKRW);
      const discountCurr = toCurr(discountKRW);
      const total = toCurr(totalKRW);

      const copyAsMarkdown = () => {
        const lines=[];
        lines.push(`# 견적서`);
        lines.push('');
        lines.push('| 항목 | 수량 | 단가 (KRW) | 단가 ('+currency+') | 합계 (KRW) | 합계 ('+currency+') |');
        lines.push('|---|---:|---:|---:|---:|---:|');
        items.forEach(it=>{
          const unitC = toCurr(it.unitKRW); const lineKRW = it.qty*it.unitKRW; const lineC = toCurr(lineKRW);
          lines.push(`| ${it.name} | ${it.qty} | ${formatMoney(it.unitKRW,'KRW')} | ${formatMoney(unitC,currency)} | ${formatMoney(lineKRW,'KRW')} | ${formatMoney(lineC,currency)} |`);
        });
        lines.push('|  |  |  |  |  |  |');
        lines.push(`| **소계** |  |  |  | **${formatMoney(subtotalKRW,'KRW')}** | **${formatMoney(subtotal,currency)}** |`);
        if ((Number(taxPct)||0) > 0) lines.push(`| 세금 (${taxPct}%) |  |  |  | ${formatMoney(taxKRW,'KRW')} | ${formatMoney(tax,currency)} |`);
        if ((Number(discount.value)||0) > 0) lines.push(`| 할인 (${discount.type==='percent'? discount.value+'%':'KRW'}) |  |  |  | -${formatMoney(discountKRW,'KRW')} | -${formatMoney(discountCurr,currency)} |`);
        lines.push(`| **총합계** |  |  |  | **${formatMoney(totalKRW,'KRW')}** | **${formatMoney(total,currency)}** |`);
        navigator.clipboard.writeText(lines.join('')).then(()=>alert('Markdown 표가 복사되었습니다.'));
      };

      const resetAll = () => { if(!confirm('초기화할까요?')) return; localStorage.clear(); location.reload(); };

      return (
        <div className="max-w-6xl mx-auto p-6">
          <div className="no-print flex items-center justify-between mb-6">
            <h1 className="text-2xl font-semibold">OBJET 통화별 수술 견적서 생성기</h1>
            <div className="flex gap-2">
              <button className="px-3 py-2 rounded-lg bg-white shadow border hover:bg-gray-50" onClick={()=>window.print()}>Print / Save PDF</button>
              <button className="px-3 py-2 rounded-lg bg-white shadow border hover:bg-gray-50" onClick={copyAsMarkdown}>Copy as Markdown</button>
              <button className="px-3 py-2 rounded-lg bg-rose-600 text-white shadow hover:bg-rose-700" onClick={resetAll}>Reset</button>
            </div>
          </div>

          <div className="grid lg:grid-cols-3 gap-6">
            {/* LEFT controls */}
            <div className="space-y-6 lg:col-span-2">
              <section className="bg-white rounded-2xl shadow-soft p-5">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="font-semibold">통화 & 환율</h2>
                  <span className="text-xs text-gray-500">기준: KRW → 외화</span>
                </div>
                <div className="flex items-center gap-2 mb-3">
                  <select className="border rounded-lg p-2" value={currency} onChange={e=>setCurrency(e.target.value)}>
                    {Object.keys(DEFAULT_FX).filter(c=>c!=='KRW').map(c=> <option key={c} value={c}>{c}</option>)}
                  </select>
                  <span className="currency-badge text-xs px-2 py-1 rounded bg-gray-100 border">1 KRW = {fx[currency]} {currency}</span>
                  <button className="ml-auto text-sm px-2 py-1 rounded-lg border hover:bg-gray-50" onClick={()=>autoFetchRates(setFx, fx)}>Auto (KRW base)</button>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  {Object.keys(fx).map(c=> (
                    <div key={c} className="flex items-center gap-2">
                      <label className="w-12 text-sm text-gray-600">{c}</label>
                      <input className="flex-1 border rounded-lg p-2" type="number" step="0.000001" value={fx[c]} onChange={e=>setFx({...fx, [c]: Number(e.target.value)})} />
                    </div>
                  ))}
                </div>
                <p className="text-xs text-gray-500 mt-2">팁: 최종 견적 전에 환율을 업데이트하세요. (상단에 Auto (KRW base) 클릭)</p>
              </section>

              <section className="bg-white rounded-2xl shadow-soft p-5">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="font-semibold text-m">항목 추가</h2>
                  {/*<button className="text-sm px-2 py-1 rounded-lg border" onClick={addCustomItem}>+ 커스텀 항목</button>*/}
                  <div className="mb-2 grid grid-cols-7 gap-1">
                    <input
                      className="col-span-4 border rounded-lg p-1.5 text-xs"
                      placeholder="항목명"
                      value={customName}
                      onChange={e=>setCustomName(e.target.value)}
                      onKeyDown={e=>{ if(e.key==='Enter') addCustomFromFields(); }}
                    />
                    <input
                      className="col-span-2 border rounded-lg p-1.5 text-xs text-right"
                      placeholder="단가 (KRW)"
                      inputMode="number"
                      step="1000"
                      value={customPriceKRW}
                      onChange={e=>setCustomPriceKRW(e.target.value)}
                      onKeyDown={e=>{ if(e.key==='Enter') addCustomFromFields(); }}
                    />
                    <button
                      className="col-span-1 px-2 py-1 text-xs rounded-lg border hover:bg-gray-50"
                      onClick={() => addCustomFromFields()}
                      title="입력한 수술명과 가격으로 항목 추가"
                    >추가</button>
                    
                      </div>  
                </div>
                <div className="max-h-64 overflow-auto pr-1 space-y-1">
                  {CATALOG.map(cat => (
                    <button key={cat.id} onClick={()=>addCatalogItem(cat)} className="w-full text-left px-3 py-2 rounded-lg border hover:bg-gray-50 flex items-center justify-between">
                      <span>{cat.name}</span>
                      <span className="text-sm text-gray-600">{formatMoney(cat.baseKRW,'KRW')}</span>
                    </button>
                  ))}
                </div>
              </section>

              <section className="bg-white rounded-2xl shadow-soft p-5">
                <h2 className="font-semibold mb-3">할인</h2>
                <div className="grid grid-cols-2 gap-3">
                  
                  <div>
                   
                    <div className="flex gap-2">
                      <select className="border rounded-lg p-2" value={discount.type} onChange={e=>setDiscount({...discount, type:e.target.value})}>
                        <option value="amount">금액 (KRW)</option>
                        <option value="percent">퍼센트 (%)</option>
                      </select>
                      <input 
                        className="flex-1 border rounded-lg p-2" 
                        type="text"
                        inputMode="numeric"
                        value={discount.value} 
                        onChange={e => {
                          const val = e.target.value.replace(/[^0-9]/g, '');
                          setDiscount({...discount, value: val ? Number(val) : 0});
                        }} 
                      />
                    </div>
                  </div>
                </div>
              </section>
            </div>

            {/* RIGHT printable quote */}
            <div className="lg:col-span-2">
              <div className="page bg-white rounded-2xl shadow-soft p-6">


                <section>
                  <table className="w-800 text-sm border-separate border-spacing-y-2">
                    <thead>
                      <tr className="text-left text-gray-800">
                        <th className="px-3 py-2 text-center w-11/12">Item</th>
                        <th className="px-3 py-2 text-right w-20">KRW</th>
                        <th className="px-3 py-2 text-right w-20">{currency}</th>
                        {/*<th className="px-3 py-2 text-right w-auto"></th>*/}
                        <th className="px-3 py-2 no-print w-20"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {items.length===0 && (
                        <tr><td className="px-3 py-4 text-gray-500" colSpan={5}>항목을 왼쪽에서 추가하세요.</td></tr>
                      )}
                      {items.map((it, idx)=>{
                        const lineKRW = it.qty * it.unitKRW; const unitC = toCurr(it.unitKRW); const lineC = toCurr(lineKRW);
                        return (
                          <tr key={idx} className="align-top">
                            <td className="px-3 py-2 w-11/12">
                              <textarea rows={1} className="w-full border rounded-lg p-2 resize-none break-words leading-tight" value={it.name} onChange={e=>updateItem(idx,{name:e.target.value})} />
                              <input className="w-full mt-1 border rounded-lg p-2 text-xs text-gray-600" placeholder="" value={it.note} onChange={e=>updateItem(idx,{note:e.target.value})} />
                            </td>
                            <td className="px-3 py-2 text-right w-20">
                              <div>{formatMoney(it.unitKRW,'KRW')}</div>
                            </td>
                            <td className="px-3 py-2 text-right w-20">{formatMoney(unitC, currency)}</td>
                            
                            <td className="px-3 py-2 no-print text-right w-20"><button onClick={()=>removeItem(idx)} className="text-rose-600 hover:underline">delete</button></td>
                          </tr>
                        );
                      })}
                    </tbody>
                    <tfoot>
                      {(Number(discount.value)||0)>0 && (
                        <tr>
                          <td className="px-3"></td>
                          <td className="px-3 text-right font-semibold w-28">- {formatMoney(discountKRW,'KRW')}</td>
                          <td className="px-3 text-right font-semibold w-28">- {formatMoney(discountCurr,currency)}</td>
                          <td className="px-3 text-right text-gray-600"> {discount.type==='percent'? `(${discount.value}%)` : ''}</td>
                          <td></td>
                        </tr>
                      )}
                      <tr>
                        <td className="px-3 pt-2"></td>
                        <td className="px-3 pt-2 text-right text-gray-900">Subtotal</td>
                        <td className="px-3 pt-2 text-right text-2xl text-gray-700 font-bold w-28">{formatMoney(totalKRW,'KRW')}</td>
                        <td className="px-3 pt-2 text-right text-2xl text-green-600 font-bold w-28">{formatMoney(total,currency)}</td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </section>

                <section className="mt-8 text-xs text-gray-500">
                  <p>※ The final cost may vary after an in-person consultation.</p>
                </section>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
  </script>
</body>
</html>
